version: "3.9"
services:

  haproxy:
    network_mode: host
    ports:
      - 80:80
    build:
      context: ./
      dockerfile: haproxy/Dockerfile
    volumes:
      - ./haproxy/haproxy.cfg:/etc/haproxy/haproxy.cfg
      - ./haproxy/map/ddos.map:/etc/haproxy/ddos.map
      - ./haproxy/map/hosts.map:/etc/haproxy/hosts.map
      - ./haproxy/map/backends.map:/etc/haproxy/backends.map
      - ./haproxy/map/blocked.map:/etc/haproxy/blocked.map
      - ./haproxy/map/whitelist.map:/etc/haproxy/whitelist.map
      - ./haproxy/map/maintenance.map:/etc/haproxy/maintenance.map
      - ./haproxy/template/maintenance.html:/etc/haproxy/maintenance.html
      - ./haproxy/template/trace.txt:/etc/haproxy/trace.txt
      - ./src/lua/scripts/:/etc/haproxy/scripts/
      - ./src/lua/libs/:/etc/haproxy/libs/
      - ./src/js/:/etc/haproxy/js/
    environment:
      # These are the hcaptcha and recaptcha test keys, not leaking any dont worry :^)
      - HCAPTCHA_SITEKEY=20000000-ffff-ffff-ffff-000000000002
      - HCAPTCHA_SECRET=0x0000000000000000000000000000000000000000
      #- RECAPTCHA_SECRET=6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe
      #- RECAPTCHA_SITEKEY=6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI
      - CAPTCHA_COOKIE_SECRET=changeme
      - POW_COOKIE_SECRET=changeme
      - HMAC_COOKIE_SECRET=changeme
      - RAY_ID=docker
      - CHALLENGE_EXPIRY=43200
      - BACKEND_NAME=servers
      - SERVER_PREFIX=websrv
      - CHALLENGE_INCLUDES_IP=1
      - POW_TIME=2
      - POW_KB=512
      - POW_DIFFICULTY=24
      - TOR_CONTROL_PORT_PASSWORD=changeme

  nginx:
    ports:
      - 81:80
    image: "nginx:latest"
    volumes:
      - ./nginx:/usr/share/nginx/html

#  tor:
#    build:
#      context: ./
#      dockerfile: tor/Dockerfile
